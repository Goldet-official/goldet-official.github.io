<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Goldet — Market</title>
<link href="https://fonts.googleapis.com/css2?family=Titan+One&display=swap" rel="stylesheet" />

<style>
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;height:100%;font-family:Arial,system-ui;background:#080808;color:#fff}

  .sidebar{position:fixed;left:0;top:0;bottom:0;width:240px;
    background: linear-gradient(180deg,#1a1200,#2e1a03);
    border-right:2px solid rgba(212,175,55,0.06);
    padding:22px;display:flex;flex-direction:column;gap:12px}
  .sidebar a{color:#ffd;text-decoration:none;padding:10px;border-radius:8px}
  .sidebar a:hover{background:rgba(212,175,55,0.08)}
  .logo{font-family:'Titan One';font-size:34px;color:#ffd700}

  .main{margin-left:260px;padding:26px}
  h1{font-family:'Titan One';color:#ffd700}

  .pack-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px;margin-top:20px}
  .pack-card{
    background:#111;border:2px solid rgba(212,175,55,0.12);
    border-radius:14px;padding:18px;box-shadow:0 6px 20px rgba(212,175,55,0.08)
  }
  .pack-title{font-size:22px;font-weight:700;color:#ffd}
  .pack-desc{font-size:14px;color:#d9c08c;margin-top:6px}
  .pack-cost{margin-top:10px;font-size:18px;color:#ffd700;font-weight:800}
  .btn-buy{
    margin-top:14px;padding:10px;width:100%;font-weight:900;
    border:none;border-radius:10px;cursor:pointer;
    background:linear-gradient(90deg,#ffd700,#b8860b);color:#000
  }

  .alert{margin-top:14px;display:none;padding:10px;border-radius:10px}
</style>
</head>
<body>

<div class="sidebar">
  <div class="logo">Goldet</div>
  <a href="stats.html">Stats</a>
  <a href="leaderboard.html">Leaderboard</a>
  <a href="chat.html">Chat</a>
  <a href="market.html">Market</a>
  <a href="golds.html">Golds</a>
  <a href="admin.html">Admin</a>
  <a href="settings.html">Settings</a>
  <div style="margin-top:auto">
    <div style="color:#d9c08c;font-size:13px">Signed in as</div>
    <div id="sidebarUser" style="font-weight:700;color:#ffd700">—</div>
  </div>
</div>

<div class="main">
  <h1>Market</h1>

  <div id="alert" class="alert"></div>

  <div id="packs" class="pack-grid"></div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import { getDatabase, ref, onValue, get, update } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDe9lhPW1DEli3moVwtywCE0ucXKoZSoXs",
  authDomain: "goldet-504aa.firebaseapp.com",
  databaseURL: "https://goldet-504aa-default-rtdb.firebaseio.com",
  projectId: "goldet-504aa",
  storageBucket: "goldet-504aa.appspot.com",
  messagingSenderId: "36312610816",
  appId: "1:36312610816:web:ded0576d78ebf1ceba00e5",
  measurementId: "G-TTJNTC824V"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const packsDiv = document.getElementById("packs");
const alertBox = document.getElementById("alert");
const sidebarUser = document.getElementById("sidebarUser");

let uid = null;
let userData = null;

function showAlert(msg, ok=false){
  alertBox.style.display = "block";
  alertBox.style.background = ok ? "rgba(40,180,40,0.14)" : "rgba(255,0,0,0.14)";
  alertBox.textContent = msg;
  setTimeout(()=> alertBox.style.display="none", 4000);
}

onAuthStateChanged(auth, async(user)=>{
  if(!user){
    window.location.href = "login.html";
    return;
  }
  uid = user.uid;
  sidebarUser.textContent = user.email;

  const userRef = ref(db, "users/" + uid);
  onValue(userRef, snap => {
    userData = snap.val() || {};
  });

  loadPacks();
});

function loadPacks(){
  const refPacks = ref(db, "marketPacks");
  onValue(refPacks, snap => {
    packsDiv.innerHTML = "";
    const packs = snap.val() || {};
    Object.keys(packs).forEach(id => {
      const p = packs[id];

      const card = document.createElement("div");
      card.className = "pack-card";
      card.innerHTML = `
        <div class="pack-title">${p.name}</div>
        <div class="pack-desc">${p.description}</div>
        <div class="pack-cost">Cost: ${p.cost} Gold</div>
        <button class="btn-buy">Buy Pack</button>
      `;

      const btn = card.querySelector(".btn-buy");
      btn.onclick = ()=> buyPack(id, p);

      packsDiv.appendChild(card);
    });
  });
}

async function buyPack(id, pack){
  if(!userData) return;

  const tokens = userData.tokens || 0;
  if(tokens < pack.cost){
    return showAlert("Not enough gold.");
  }

  // subtract tokens
  const newTokens = tokens - pack.cost;

  // determine amount of items
  const count = Math.floor(
    Math.random() * (pack.maxItems - pack.minItems + 1)
  ) + pack.minItems;

  const poolKeys = Object.keys(pack.goldPool);
  const userGolds = userData.stats?.golds || {};
  let unlocked = userData.goldsUnlocked || 0;

  for(let i=0;i<count;i++){
    const pick = poolKeys[Math.floor(Math.random()*poolKeys.length)];
    const g = pack.goldPool[pick];
    const newId = "gold_" + Date.now() + "_" + i;
    userGolds[newId] = {
      name: g.name,
      rarity: g.rarity,
      obtainedAt: Date.now()
    };
    unlocked++;
  }

  await update(ref(db, "users/" + uid), {
    tokens: newTokens,
    packsOpened: (userData.packsOpened||0) + 1,
    goldsUnlocked: unlocked,
    ["stats/golds"]: userGolds
  });

  showAlert(`You opened ${pack.name} and received ${count} items!`, true);
}
</script>

</body>
</html>
