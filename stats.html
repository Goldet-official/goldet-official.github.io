<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Goldet — Stats</title>
<link href="https://fonts.googleapis.com/css2?family=Titan+One&display=swap" rel="stylesheet" />
<style>
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;height:100%;font-family:Arial,system-ui;background:linear-gradient(180deg,#050505,#0b0b0b);color:#fff}
  /* Sidebar */
  .sidebar{position:fixed;left:0;top:0;bottom:0;width:240px;background: linear-gradient(180deg,#1a1200,#2e1a03);border-right: 2px solid rgba(212,175,55,0.06);padding:22px;display:flex;flex-direction:column;gap:12px}
  .logo{font-family:'Titan One',cursive;color:#ffd700;font-size:34px;text-shadow:0 0 8px rgba(212,175,55,0.15)}
  .nav a{display:block;color:#ffd;text-decoration:none;padding:10px;border-radius:8px;margin:6px 0;background:transparent}
  .nav a:hover{background:rgba(212,175,55,0.06)}
  /* Main */
  .main{margin-left:260px;padding:30px;min-height:100vh}
  h1{font-family:'Titan One',cursive;color:#ffdf80;margin:0 0 12px}
  .profile-card{background:#0f0f0f;border:2px solid rgba(212,175,55,0.12);padding:18px;border-radius:12px;display:flex;gap:16px;align-items:center;box-shadow:0 6px 24px rgba(212,175,55,0.06)}
  .avatar{width:96px;height:96px;border-radius:999px;background:linear-gradient(90deg,#ffd700,#b8860b);box-shadow:0 0 12px rgba(255,215,0,0.4)}
  .profile-info{flex:1}
  .username{font-family:'Titan One';font-size:28px;color:#ffd700;margin:0}
  .small{color:#d9c08c}
  .level-bar{height:12px;background:#1a1a1a;border-radius:12px;overflow:hidden;border:1px solid rgba(212,175,55,0.12);margin-top:8px}
  .bar-fill{height:100%;background:linear-gradient(90deg,#ffd700,#b8860b);width:0%}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;margin-top:20px}
  .stat-box{background:#0f0f0f;border:2px solid rgba(212,175,55,0.12);padding:14px;border-radius:12px;text-align:center;box-shadow:0 6px 24px rgba(212,175,55,0.04)}
  .stat-title{color:#f6e6b4;margin-bottom:6px}
  .stat-value{font-size:28px;color:#ffd700;font-weight:700}
  .actions{display:flex;gap:10px;margin-top:12px}
  .btn{padding:10px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,#ffd700,#b8860b);color:#070707;font-weight:800;cursor:pointer}
  .ghost{background:transparent;border:2px solid rgba(212,175,55,0.12);color:#ffd}
  .list{margin-top:18px;display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px}
  .gold-card{background:#111;border-radius:10px;padding:12px;border:1px solid rgba(212,175,55,0.06);text-align:center}
  .badge{display:inline-block;padding:6px 8px;border-radius:8px;background:rgba(255,215,0,0.12);color:#ffe;font-weight:700}
  .alert{margin-top:12px;padding:10px;border-radius:8px;display:none}
  @media(max-width:900px){.main{margin-left:0;padding:16px}}
</style>
</head>
<body>

<div class="sidebar">
  <div class="logo">Goldet</div>
  <nav>
    <a href="stats.html">Stats</a>
    <a href="leaderboard.html">Leaderboard</a>
    <a href="chat.html">Chat</a>
    <a href="market.html">Market</a>
    <a href="golds.html">Golds</a>
    <a href="settings.html">Settings</a>
  </nav>
  <div style="margin-top:auto">
    <div class="small">Signed in as</div>
    <div id="sidebar-username" style="font-weight:700;color:#ffd700">—</div>
    <button id="logoutBtn" class="ghost" style="width:100%;margin-top:10px">Logout</button>
  </div>
</div>

<div class="main">
  <h1>Your Profile</h1>

  <div class="profile-card">
    <div class="avatar" id="avatarImg"></div>
    <div class="profile-info">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <div class="username" id="usernameDisplay">Loading...</div>
          <div class="small" id="emailDisplay"></div>
          <div style="margin-top:6px"><span class="badge" id="roleBadge">Player</span></div>
        </div>
        <div style="text-align:right">
          <div class="small">Level</div>
          <div style="font-size:20px;font-weight:800" id="levelDisplay">0</div>
        </div>
      </div>

      <div class="level-bar">
        <div class="bar-fill" id="xpBar"></div>
      </div>

      <div class="actions">
        <button id="openPackBtn" class="btn">Open Pack</button>
        <button id="editProfileBtn" class="ghost">Edit Profile</button>
      </div>

      <div id="profileAlert" class="alert"></div>
    </div>
  </div>

  <div class="grid" style="margin-top:20px">
    <div class="stat-box">
      <div class="stat-title">Gold</div>
      <div class="stat-value" id="tokensDisplay">0</div>
    </div>
    <div class="stat-box">
      <div class="stat-title">Golds Unlocked</div>
      <div class="stat-value" id="goldsDisplay">0 / 0</div>
    </div>
    <div class="stat-box">
      <div class="stat-title">Packs Opened</div>
      <div class="stat-value" id="packsDisplay">0</div>
    </div>
    <div class="stat-box">
      <div class="stat-title">Messages Sent</div>
      <div class="stat-value" id="messagesDisplay">0</div>
    </div>
  </div>

  <h2 style="margin-top:24px;font-family:'Titan One';color:#ffd700">Your Golds</h2>
  <div id="goldsList" class="list"></div>

  <h2 style="margin-top:18px;font-family:'Titan One';color:#ffd700">Badges</h2>
  <div id="badgesList" class="list"></div>
</div>

<!-- Firebase (modular) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import { getDatabase, ref, onValue, get, update } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDe9lhPW1DEli3moVwtywCE0ucXKoZSoXs",
  authDomain: "goldet-504aa.firebaseapp.com",
  databaseURL: "https://goldet-504aa-default-rtdb.firebaseio.com",
  projectId: "goldet-504aa",
  storageBucket: "goldet-504aa.appspot.com",
  messagingSenderId: "36312610816",
  appId: "1:36312610816:web:ded0576d78ebf1ceba00e5",
  measurementId: "G-TTJNTC824V"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const usernameDisplay = document.getElementById('usernameDisplay');
const sidebarUsername = document.getElementById('sidebar-username');
const emailDisplay = document.getElementById('emailDisplay');
const levelDisplay = document.getElementById('levelDisplay');
const xpBar = document.getElementById('xpBar');
const tokensDisplay = document.getElementById('tokensDisplay');
const goldsDisplay = document.getElementById('goldsDisplay');
const packsDisplay = document.getElementById('packsDisplay');
const messagesDisplay = document.getElementById('messagesDisplay');
const goldsList = document.getElementById('goldsList');
const badgesList = document.getElementById('badgesList');
const roleBadge = document.getElementById('roleBadge');
const openPackBtn = document.getElementById('openPackBtn');
const logoutBtn = document.getElementById('logoutBtn');
const profileAlert = document.getElementById('profileAlert');

let currentUID = null;
let currentUsername = null;

// helper
function showAlert(el, msg, ok=false){
  el.style.display = 'block';
  el.style.background = ok ? 'rgba(40,180,40,0.12)' : 'rgba(255,0,0,0.12)';
  el.textContent = msg;
  setTimeout(()=> el.style.display = 'none', 4000);
}
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

// prefer Auth, fallback to localStorage
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUID = user.uid;
    loadUserByUID(currentUID);
  } else {
    // fallback: localStorage keys from your login flow
    const uidLS = localStorage.getItem('goldetCurrentUID') || localStorage.getItem('currentUser');
    const unameLS = localStorage.getItem('goldetCurrentUsername') || localStorage.getItem('goldetCurrentUser');
    if (uidLS) {
      currentUID = uidLS;
      loadUserByUID(currentUID);
    } else if (unameLS) {
      // if you only stored username (not UID) assume you used username->uid mapping
      // try to fetch /usernames/{username} -> uid
      const uname = unameLS;
      const usernamesRef = ref(db, 'usernames/' + uname);
      const snap = await get(usernamesRef);
      if (snap.exists()){
        currentUID = snap.val();
        loadUserByUID(currentUID);
      } else {
        // no session: redirect to login
        window.location.href = 'login.html';
      }
    } else {
      window.location.href = 'login.html';
    }
  }
});

async function loadUserByUID(uid){
  currentUID = uid;
  // listen to /users/{uid} for realtime updates
  const userRef = ref(db, 'users/' + uid);
  onValue(userRef, (snap) => {
    const data = snap.val();
    if (!data) return;
    renderUserData(data);
  });
}

// render and wire actions
function renderUserData(d){
  currentUsername = d.username || localStorage.getItem('goldetCurrentUsername') || 'Unknown';
  usernameDisplay.textContent = d.username || 'Unknown';
  sidebarUsername.textContent = d.username || 'Unknown';
  emailDisplay.textContent = d.email || '';
  levelDisplay.textContent = d.level ?? 0;
  const xp = Number(d.xp ?? 0);
  xpBar.style.width = Math.min(100, xp) + '%';
  tokensDisplay.textContent = d.tokens ?? 0;
  goldsDisplay.textContent = (d.goldsUnlocked ?? 0) + ' / ' + (d.totalGolds ?? 0);
  packsDisplay.textContent = d.packsOpened ?? 0;
  messagesDisplay.textContent = d.messages ?? 0;
  roleBadge.textContent = (d.role === 'admin') ? 'Admin' : 'Player';
  roleBadge.style.background = d.role === 'admin' ? 'rgba(255,50,50,0.12)' : 'rgba(255,215,0,0.12)';

  // golds list (d.stats.golds is expected to be object {goldId: {name,img,rarity,obtainedAt}})
  goldsList.innerHTML = '';
  const golds = (d.stats && d.stats.golds) ? d.stats.golds : {};
  const total = Object.keys(golds).length;
  if (total === 0) {
    goldsList.innerHTML = '<div style="color:#d9c08c">No golds yet</div>';
  } else {
    for (const k of Object.keys(golds)){
      const g = golds[k];
      const card = document.createElement('div');
      card.className = 'gold-card';
      card.innerHTML = `<div style="font-weight:800">${escapeHtml(g.name || k)}</div>
                        <div style="font-size:12px;color:#d9c08c">${escapeHtml(g.rarity || '')}</div>`;
      goldsList.appendChild(card);
    }
  }

  // badges
  badgesList.innerHTML = '';
  const badges = d.badges || {};
  if (Object.keys(badges).length === 0) badgesList.innerHTML = '<div style="color:#d9c08c">No badges yet</div>';
  else {
    for (const id of Object.keys(badges)){
      const b = badges[id];
      const el = document.createElement('div');
      el.className = 'gold-card';
      el.innerHTML = `<div style="font-weight:800">${escapeHtml(b.title || id)}</div><div style="font-size:12px;color:#d9c08c">${escapeHtml(b.desc||'')}</div>`;
      badgesList.appendChild(el);
    }
  }
}

// Open pack example (adds a random gold from /golds and increments packsOpened)
openPackBtn.addEventListener('click', async () => {
  if (!currentUID) return showAlert(profileAlert, 'Not signed in.');
  try {
    // pick random gold from /golds
    const goldsRef = ref(db, 'golds');
    const snap = await get(goldsRef);
    const all = snap.val() || {};
    const keys = Object.keys(all);
    if (!keys.length) return showAlert(profileAlert, 'No golds available in the market.');

    const pick = all[keys[Math.floor(Math.random()*keys.length)]];
    const goldId = 'gold_' + Date.now();

    // atomic-ish update: increment packsOpened and add gold to stats.golds
    const userRef = ref(db, 'users/' + currentUID);
    const currentSnap = await get(userRef);
    const userData = currentSnap.exists() ? currentSnap.val() : {};
    const packsOpened = (userData.packsOpened ?? 0) + 1;
    const goldsObj = (userData.stats && userData.stats.golds) ? userData.stats.golds : {};
    goldsObj[goldId] = { name: pick.name, rarity: pick.rarity, obtainedAt: Date.now() };
    // and increment goldsUnlocked & tokens optionally
    const updates = {
      packsOpened,
      ['stats/golds']: goldsObj,
      goldsUnlocked: (userData.goldsUnlocked ?? 0) + 1
    };
    await update(ref(db, 'users/' + currentUID), updates);

    showAlert(profileAlert, `You opened a pack and got: ${pick.name}`, true);

  } catch (e) {
    console.error(e);
    showAlert(profileAlert, 'Failed to open pack: ' + (e.message || e));
  }
});

// Logout
logoutBtn.addEventListener('click', async () => {
  try {
    await signOut(auth);
  } catch {}
  // clear local storage session too
  localStorage.removeItem('goldetCurrentUID');
  localStorage.removeItem('goldetCurrentUsername');
  window.location.href = 'login.html';
});
</script>
</body>
</html>
