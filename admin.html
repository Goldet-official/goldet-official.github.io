<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Goldet — Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Titan+One&display=swap" rel="stylesheet" />
<style>
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Arial,system-ui;background:linear-gradient(180deg,#050505,#0b0b0b);color:#fff}
  /* Sidebar */
  .sidebar{position:fixed;left:0;top:0;bottom:0;width:240px;
    background: linear-gradient(180deg,#1a1200,#2e1a03);
    border-right:2px solid rgba(212,175,55,0.06);
    padding:22px;display:flex;flex-direction:column;gap:12px}
  .sidebar a{color:#ffd;text-decoration:none;padding:10px;border-radius:8px}
  .sidebar a:hover{background:rgba(212,175,55,0.08)}
  .logo{font-family:'Titan One';font-size:34px;color:#ffd700}
  /* Main */
  .main{margin-left:260px;padding:30px;min-height:100vh}
  h1{font-family:'Titan One',cursive;color:#ffdf80;margin:0 0 12px}
  .top-row{display:flex;gap:12px;align-items:center;justify-content:space-between}
  .admin-box{background:#0f0f0f;border:2px solid rgba(212,175,55,0.12);padding:12px;border-radius:10px}
  .small{font-size:13px;color:#d9c08c}
  .search{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(212,175,55,0.12);background:#0f0f0f;color:#ffd}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:20px;margin-top:18px}
  .panel{background:#0f0f0f;border:2px solid rgba(212,175,55,0.12);padding:14px;border-radius:12px}
  .user-list{max-height:70vh;overflow:auto}
  .user-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);margin-bottom:8px;background:rgba(255,255,255,0.01);cursor:pointer}
  .user-row:hover{background:rgba(212,175,55,0.03)}
  .user-row .meta{font-size:13px;color:#d9c08c}
  label{display:block;margin-top:10px;color:#f6e6b4;font-weight:700}
  input[type=text], input[type=number], select, textarea{
    width:100%;padding:10px;border-radius:8px;border:1px solid rgba(212,175,55,0.12);background:#0b0b0b;color:#ffd;outline:none;margin-top:6px;
  }
  .row{display:flex;gap:10px}
  .col{flex:1}
  .actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  .btn{padding:10px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,#ffd700,#b8860b);color:#070707;font-weight:800;cursor:pointer}
  .ghost{background:transparent;border:2px solid rgba(212,175,55,0.12);color:#ffd}
  .danger{background:linear-gradient(90deg,#ff7070,#d94e4e);color:#fff}
  .alert{margin-top:10px;padding:10px;border-radius:8px;display:none}
  .small-muted{font-size:12px;color:#bfae74;margin-top:10px}
  pre{white-space:pre-wrap;background:#070707;padding:10px;border-radius:8px;color:#ffd}
  @media(max-width:980px){
    .grid{grid-template-columns:1fr; }
    .user-list{max-height:none}
  }
</style>
</head>
<body>

<div class="sidebar">
  <div class="logo">Goldet</div>
  <a href="stats.html">Stats</a>
  <a href="leaderboard.html">Leaderboard</a>
  <a href="chat.html">Chat</a>
  <a href="market.html">Market</a>
  <a href="golds.html">Golds</a>
  <a href="admin.html">Admin</a>
  <a href="settings.html">Settings</a>
  <div style="margin-top:auto">
    <div style="color:#d9c08c;font-size:13px">Signed in as</div>
    <div id="sidebarUser" style="font-weight:700;color:#ffd700">—</div>
  </div>
</div>

  <div style="margin-top:auto">
    <div class="small">Signed in as</div>
    <div id="sidebar-username" style="font-weight:700;color:#ffd700">—</div>
    <button id="signOutBtn" class="ghost" style="width:100%;margin-top:10px">Sign out</button>
  </div>
</div>

<div class="main">
  <div class="top-row">
    <div>
      <h1>Admin Panel</h1>
      <div class="small">Manage users, approvals, badges, colors and live stats.</div>
    </div>

    <div class="admin-box" id="adminBox">
      <div id="adminStatus" class="small">Checking admin...</div>
      <div id="adminAlert" class="alert"></div>
    </div>
  </div>

  <div style="margin-top:14px">
    <input id="searchBox" class="search" placeholder="Search username or email (starts-with)">
  </div>

  <div class="grid">
    <!-- LEFT: user list -->
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">All Users</div>
        <div class="small-muted" id="usersCount">0 users</div>
      </div>

      <div class="user-list" id="userList">Loading…</div>
    </div>

    <!-- RIGHT: user editor -->
    <div class="panel" id="editorPanel">
      <div id="editorEmpty" class="small-muted">Select a user from the list to view and edit details.</div>

      <div id="editor" style="display:none">
        <label>Username</label>
        <input id="e_username" type="text">

        <label>Email</label>
        <input id="e_email" type="text">

        <label>Approved</label>
        <select id="e_approved"><option value="true">Approved</option><option value="false">Not approved</option></select>

        <label>Is Admin</label>
        <select id="e_isAdmin"><option value="true">Yes</option><option value="false">No</option></select>

        <div class="row">
          <div class="col">
            <label>Name color (hex)</label>
            <input id="e_nameColor" type="text" placeholder="#ffffff">
          </div>
          <div class="col">
            <label>Text color (hex)</label>
            <input id="e_textColor" type="text" placeholder="#000000">
          </div>
        </div>

        <label>Level</label>
        <input id="e_level" type="number">

        <div class="row">
          <div class="col">
            <label>Packs Opened</label>
            <input id="e_packs" type="number">
          </div>
          <div class="col">
            <label>Messages Sent</label>
            <input id="e_messages" type="number">
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Golds Unlocked</label>
            <input id="e_goldsUnlocked" type="number">
          </div>
          <div class="col">
            <label>Total Golds</label>
            <input id="e_totalGolds" type="number">
          </div>
        </div>

        <label>Badges (JSON object)</label>
        <textarea id="e_badges" rows="4" placeholder='{"badgeId": {"title":"X","desc":"Y"}}'></textarea>

        <div class="actions">
          <button id="saveBtn" class="btn">Save changes</button>
          <button id="approveBtn" class="btn">Approve</button>
          <button id="declineBtn" class="ghost">Decline</button>
          <button id="deleteBtn" class="danger">Delete user</button>
        </div>

        <div id="editorAlert" class="alert"></div>

        <div style="margin-top:12px">
          <div class="small-muted">Raw user JSON (live):</div>
          <pre id="rawJson" aria-hidden="true">–</pre>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase modules -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import {
  getDatabase,
  ref,
  onValue,
  get,
  update,
  set,
  remove,
  child,
  query,
  orderByChild,
  startAt
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

/* ------------------ CONFIG ------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyDe9lhPW1DEli3moVwtywCE0ucXKoZSoXs",
  authDomain: "goldet-504aa.firebaseapp.com",
  databaseURL: "https://goldet-504aa-default-rtdb.firebaseio.com",
  projectId: "goldet-504aa",
  storageBucket: "goldet-504aa.appspot.com",
  messagingSenderId: "36312610816",
  appId: "1:36312610816:web:ded0576d78ebf1ceba00e5",
  measurementId: "G-TTJNTC824V"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* ------------------ UI ------------------ */
const adminStatus = document.getElementById('adminStatus');
const adminAlert = document.getElementById('adminAlert');
const signOutBtn = document.getElementById('signOutBtn');
const userListEl = document.getElementById('userList');
const usersCountEl = document.getElementById('usersCount');
const searchBox = document.getElementById('searchBox');

const editor = document.getElementById('editor');
const editorEmpty = document.getElementById('editorEmpty');
const rawJson = document.getElementById('rawJson');
const editorAlert = document.getElementById('editorAlert');

const e_username = document.getElementById('e_username');
const e_email = document.getElementById('e_email');
const e_approved = document.getElementById('e_approved');
const e_isAdmin = document.getElementById('e_isAdmin');
const e_nameColor = document.getElementById('e_nameColor');
const e_textColor = document.getElementById('e_textColor');
const e_level = document.getElementById('e_level');
const e_packs = document.getElementById('e_packs');
const e_messages = document.getElementById('e_messages');
const e_goldsUnlocked = document.getElementById('e_goldsUnlocked');
const e_totalGolds = document.getElementById('e_totalGolds');
const e_badges = document.getElementById('e_badges');

const saveBtn = document.getElementById('saveBtn');
const approveBtn = document.getElementById('approveBtn');
const declineBtn = document.getElementById('declineBtn');
const deleteBtn = document.getElementById('deleteBtn');

let allUsers = {};        // uid -> data
let filteredUids = [];    // for search
let selectedUID = null;
let currentAdminUID = null;
let currentAdminUsername = null;

/* ------------------ HELPERS ------------------ */
function showAlert(el, msg, ok=false){
  el.style.display = 'block';
  el.style.background = ok ? 'rgba(40,180,40,0.12)' : 'rgba(255,0,0,0.12)';
  el.textContent = msg;
  setTimeout(()=> el.style.display = 'none', 4000);
}
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function makeEmailFromUsername(name){ return `${name}@goldet.internal`; }

/* ------------------ AUTH & ADMIN CHECK ------------------ */
// Sign-out button
signOutBtn.onclick = async () => { try{ await signOut(auth); }catch(e){} window.location.href='login.html'; };

// When auth changes — verify admin access
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    // Not signed in — show small login prompt inside adminStatus
    adminStatus.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:8px">
        <input id="adminUser" placeholder="admin username" style="padding:8px;border-radius:6px;background:#0f0f0f;color:#ffd;border:1px solid rgba(212,175,55,0.06)">
        <input id="adminPass" type="password" placeholder="password" style="padding:8px;border-radius:6px;background:#0f0f0f;color:#ffd;border:1px solid rgba(212,175,55,0.06)">
        <div style="display:flex;gap:8px;margin-top:6px"><button id="adminSignIn" class="btn">Sign in</button></div>
        <div class="small-muted" style="margin-top:6px">Sign in with admin account (Auth + users.{uid}.isAdmin)</div>
      </div>`;
    document.getElementById('adminSignIn').onclick = adminSignInHandler;
    userListEl.innerHTML = '<div class="small-muted">Sign in as admin to manage users.</div>';
    return;
  }

  // User signed in — check users/{uid}.isAdmin and admin/{username}
  currentAdminUID = user.uid;
  try {
    const snap = await get(ref(db, `users/${currentAdminUID}`));
    const data = snap.exists() ? snap.val() : null;
    if (!data || !data.isAdmin) {
      adminStatus.textContent = "Signed in — not admin.";
      // sign out to prevent accidental modification
      await signOut(auth);
      userListEl.innerHTML = '<div class="small-muted">Account is not authorized as admin.</div>';
      return;
    }
    // additionally check /admin/{username} truthy mapping if you use that
    const username = data.username || 'unknown';
    const adminMapSnap = await get(ref(db, `admin/${username}`));
    if (!adminMapSnap.exists()) {
      // If you prefer to control admin via /admin mapping, require it:
      // await set(ref(db, `admin/${username}`), true); // optional: uncomment to auto-register
      // For safety, require presence; here we require it:
      adminStatus.textContent = "Signed in — not authorized (admin mapping missing).";
      await signOut(auth);
      userListEl.innerHTML = '<div class="small-muted">Admin mapping not found. Ask owner to add you under /admin.</div>';
      return;
    }

    currentAdminUsername = username;
    adminStatus.innerHTML = `<div class="small">Signed in as <b style="color:#ffd700">${escapeHtml(username)}</b></div>`;
    // load all users now that admin is verified
    startUsersListener();
  } catch (e) {
    console.error(e);
    adminStatus.textContent = "Admin check failed.";
  }
});

/* ------------------ ADMIN SIGN-IN HANDLER (form) ------------------ */
async function adminSignInHandler(){
  const u = document.getElementById('adminUser').value.trim();
  const p = document.getElementById('adminPass').value;
  if (!u || !p) return showAlert(adminAlert, "Enter username & password.");
  try {
    const email = makeEmailFromUsername(u);
    const cred = await signInWithEmailAndPassword(auth, email, p);
    // onAuthStateChanged will validate admin status and proceed
    showAlert(adminAlert, "Signed in — verifying...", true);
  } catch (e) {
    console.error(e);
    showAlert(adminAlert, "Sign in failed: " + (e.message || e));
  }
}

/* ------------------ USERS LIST (realtime) ------------------ */
let usersRefUnsubscribe = null;

function startUsersListener(){
  const usersRef = ref(db, 'users');
  // attach realtime listener
  onValue(usersRef, (snap) => {
    allUsers = snap.val() || {};
    renderUserList();
  }, (err) => {
    console.error('users onValue', err);
    userListEl.innerHTML = '<div class="small-muted">Failed to load users.</div>';
  });
}

/* ------------------ RENDER / SEARCH ------------------ */
function renderUserList(){
  // build array of [uid, data] and optionally filter by searchBox
  const q = (searchBox.value || '').toLowerCase();
  const rows = [];
  for (const uid in allUsers){
    const u = allUsers[uid];
    const name = (u.username || '').toLowerCase();
    const email = (u.email || '').toLowerCase();
    if (q){
      if (!name.startsWith(q) && !email.startsWith(q)) continue;
    }
    rows.push([uid, u]);
  }
  rows.sort((a,b)=> (a[1].username || '').localeCompare(b[1].username || ''));

  usersCountEl.textContent = `${rows.length} users`;
  userListEl.innerHTML = '';
  if (!rows.length){
    userListEl.innerHTML = '<div class="small-muted">No users found.</div>';
    return;
  }

  for (const [uid, u] of rows){
    const div = document.createElement('div');
    div.className = 'user-row';
    const left = document.createElement('div');
    left.innerHTML = `<div style="font-weight:800">${escapeHtml(u.username || uid)}</div>
                      <div class="meta">${escapeHtml(u.email || '')} • ${u.isAdmin ? 'Admin' : 'Player'}</div>`;
    const right = document.createElement('div');
    right.innerHTML = `<div style="text-align:right"><div class="small">${u.approved ? 'Approved':'Pending'}</div><div class="meta">${u.stats?.messagesSent ?? 0} msgs</div></div>`;
    div.appendChild(left);
    div.appendChild(right);
    div.onclick = () => selectUser(uid);
    userListEl.appendChild(div);
  }
}

/* search box */
searchBox.addEventListener('input', () => renderUserList());

/* ------------------ SELECT USER ------------------ */
function selectUser(uid){
  selectedUID = uid;
  const d = allUsers[uid] || {};
  editorEmpty.style.display = 'none';
  editor.style.display = 'block';
  rawJson.textContent = JSON.stringify(d, null, 2);

  e_username.value = d.username || '';
  e_email.value = d.email || '';
  e_approved.value = (d.approved === true || d.approved === 'true') ? 'true' : 'false';
  e_isAdmin.value = d.isAdmin ? 'true' : 'false';
  e_nameColor.value = (d.chatColor && d.chatColor.name) ? d.chatColor.name : '#ffffff';
  e_textColor.value = (d.chatColor && d.chatColor.text) ? d.chatColor.text : '#000000';
  e_level.value = d.level ?? 0;
  e_packs.value = (d.stats && d.stats.packsOpened) ? d.stats.packsOpened : 0;
  e_messages.value = (d.stats && d.stats.messagesSent) ? d.stats.messagesSent : 0;
  e_goldsUnlocked.value = d.goldsUnlocked ?? 0;
  e_totalGolds.value = d.totalGolds ?? 0;
  try { e_badges.value = JSON.stringify(d.badges || {}, null, 2); } catch(e){ e_badges.value = '{}'; }
}

/* ------------------ SAVE CHANGES ------------------ */
saveBtn.onclick = async () => {
  if (!selectedUID) return showAlert(editorAlert, 'Select a user first.');
  try {
    const newUsername = e_username.value.trim();
    const newEmail = e_email.value.trim();
    const approved = e_approved.value === 'true';
    const isAdmin = e_isAdmin.value === 'true';
    const nameColor = e_nameColor.value.trim() || '#ffffff';
    const textColor = e_textColor.value.trim() || '#000000';
    const level = Number(e_level.value) || 0;
    const packsOpened = Number(e_packs.value) || 0;
    const messagesSent = Number(e_messages.value) || 0;
    const goldsUnlocked = Number(e_goldsUnlocked.value) || 0;
    const totalGolds = Number(e_totalGolds.value) || 0;

    let badgesObj = {};
    try { badgesObj = JSON.parse(e_badges.value || '{}'); } catch (err) {
      return showAlert(editorAlert, 'Badges must be valid JSON.');
    }

    // update user object
    const updates = {
      username: newUsername,
      email: newEmail,
      approved,
      isAdmin,
      chatColor: { name: nameColor, text: textColor },
      level,
      packsOpened,
      messages: messagesSent,
      goldsUnlocked,
      totalGolds,
      badges: badgesObj
    };

    // stats nested structure if you want to keep stats under stats
    if (allUsers[selectedUID]?.stats !== undefined) {
      // keep `stats` nested as previously used by your system
      updates['stats/packsOpened'] = packsOpened;
      updates['stats/messagesSent'] = messagesSent;
      // replace stats.golds only if you send it (we keep golds stored separately)
    }

    // perform update
    await update(ref(db, `users/${selectedUID}`), updates);

    // also maintain /admin mapping if isAdmin changed: set admin/{username} = true or remove
    if (isAdmin) {
      await set(ref(db, `admin/${newUsername}`), true);
    } else {
      // attempt to remove mapping for previous username(s)
      try { await remove(ref(db, `admin/${newUsername}`)); } catch(e){}
    }

    // if username changed we should update /usernames map if you use one
    if (allUsers[selectedUID] && allUsers[selectedUID].username && allUsers[selectedUID].username !== newUsername) {
      // remove previous mapping and add new mapping if you use /usernames/{username} => uid
      try {
        const prev = allUsers[selectedUID].username;
        await remove(ref(db, `usernames/${prev}`));
      } catch(e){}
      try { await set(ref(db, `usernames/${newUsername}`), selectedUID); } catch(e){}
    }

    showAlert(editorAlert, 'Saved changes.', true);
  } catch (e) {
    console.error(e);
    showAlert(editorAlert, 'Save failed: ' + (e.message||e));
  }
};

/* ------------------ APPROVE / DECLINE / DELETE ------------------ */
approveBtn.onclick = async () => {
  if (!selectedUID) return showAlert(editorAlert, 'Select a user first.');
  try {
    await update(ref(db, `users/${selectedUID}`), { approved: true });
    showAlert(editorAlert, 'User approved.', true);
  } catch(e){ console.error(e); showAlert(editorAlert, 'Approve failed.'); }
};

declineBtn.onclick = async () => {
  if (!selectedUID) return showAlert(editorAlert, 'Select a user first.');
  try {
    await update(ref(db, `users/${selectedUID}`), { approved: false });
    // remove usernames mapping if exists (so name becomes available)
    const u = allUsers[selectedUID];
    if (u && u.username) await remove(ref(db, `usernames/${u.username}`));
    showAlert(editorAlert, 'User declined.', true);
  } catch(e){ console.error(e); showAlert(editorAlert, 'Decline failed.'); }
};

deleteBtn.onclick = async () => {
  if (!selectedUID) return showAlert(editorAlert, 'Select a user first.');
  if (!confirm('Delete this user record from Realtime DB? This will not delete their Auth account.')) return;
  try {
    const u = allUsers[selectedUID];
    if (u && u.username) await remove(ref(db, `usernames/${u.username}`));
    await remove(ref(db, `users/${selectedUID}`));
    // optionally remove admin mapping
    if (u && u.username) await remove(ref(db, `admin/${u.username}`));
    selectedUID = null;
    editor.style.display = 'none';
    editorEmpty.style.display = 'block';
    showAlert(editorAlert, 'User record removed.', true);
  } catch(e){ console.error(e); showAlert(editorAlert, 'Delete failed.'); }
};

/* ------------------ make sure UI updates when DB changes live --------------- */
/* We already attach onValue to /users in startUsersListener() so changes will flow
   into allUsers and re-render the list. If the currently selected user changes,
   then selectUser is not automatically re-run — but onValue will update allUsers,
   so we refresh editor display if it's the same UID. */

function watchSelectedLive(){
  if (!selectedUID) return;
  const snap = allUsers[selectedUID];
  if (!snap) return;
  // update editor fields to reflect live changes (but do not override if admin is typing)
  rawJson.textContent = JSON.stringify(snap, null, 2);
}

/* run a small interval to refresh editor display if the selected user info changed */
setInterval(() => {
  if (selectedUID && allUsers[selectedUID]) watchSelectedLive();
}, 1000);

</script>
</body>
</html>
