<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Panel | Goldet</title>

<link href="https://fonts.googleapis.com/css2?family=Titan+One&display=swap" rel="stylesheet">

<style>
  body {
    margin: 0;
    background: #050505;
    color: #ffd;
    font-family: Arial, system-ui;
    display: flex;
  }

  /* Sidebar */
  .sidebar {
    width: 260px;
    height: 100vh;
    background: #0d0d0d;
    border-right: 2px solid rgba(212,175,55,0.15);
    padding: 20px;
  }
  .sidebar h2 {
    font-family: 'Titan One', cursive;
    color: #ffd700;
    text-align: center;
    margin-bottom: 20px;
  }
  .menuBtn {
    width: 100%;
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 10px;
    border: none;
    background: linear-gradient(120deg,#ffd700,#b8860b);
    color: #050505;
    font-weight: 700;
    cursor: pointer;
    font-size: 16px;
  }

  /* Main panel */
  .main {
    flex: 1;
    padding: 20px;
  }

  .card {
    background: #0d0d0d;
    border: 2px solid rgba(212,175,55,0.15);
    padding: 20px;
    border-radius: 18px;
    box-shadow: 0 6px 30px rgba(212,175,55,0.09);
    margin-bottom: 25px;
  }

  h1 {
    font-family: 'Titan One', cursive;
    color: #ffd700;
    margin-top: 0;
  }

  .userBox, .pendingBox {
    padding: 12px;
    border: 1px solid rgba(212,175,55,0.25);
    border-radius: 10px;
    margin-bottom: 12px;
  }

  button.smallBtn {
    padding: 7px 12px;
    background: #ffd700;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    color: #050505;
    font-weight: bold;
    margin-left: 8px;
  }

  .alert {
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: none;
  }
</style>
</head>
<body>

<div class="sidebar">
  <h2>ADMIN</h2>
  <button class="menuBtn" onclick="showSection('pending')">Pending Users</button>
  <button class="menuBtn" onclick="showSection('users')">All Users</button>
  <button class="menuBtn" onclick="showSection('gamestate')">Game Controls</button>
  <button class="menuBtn" onclick="logout()">Logout</button>
</div>

<div class="main">

  <div id="alertBox" class="alert"></div>

  <!-- Pending Users -->
  <div id="pending" class="section">
    <div class="card">
      <h1>Pending Approvals</h1>
      <div id="pendingList">Loading...</div>
    </div>
  </div>

  <!-- All Users -->
  <div id="users" class="section" style="display:none;">
    <div class="card">
      <h1>All Users</h1>
      <div id="usersList">Loading...</div>
    </div>
  </div>

  <!-- Game State Controls -->
  <div id="gamestate" class="section" style="display:none;">
    <div class="card">
      <h1>Game Controls</h1>

      <label>Global Multiplier</label>
      <input id="globalMultiplier" type="number" style="width:120px;padding:8px;background:#121212;border-radius:6px;color:#ffd;">
      <button class="smallBtn" onclick="saveGameState()">Save</button>

      <h3>Current Game State:</h3>
      <pre id="gameStateBox" style="white-space:pre-wrap;"></pre>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { 
  getDatabase, ref, get, set, update, remove 
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";
import { 
  getAuth, signOut, onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDe9lhPW1DEli3moVwtywCE0ucXKoZSoXs",
  authDomain: "goldet-504aa.firebaseapp.com",
  databaseURL: "https://goldet-504aa-default-rtdb.firebaseio.com",
  projectId: "goldet-504aa",
  storageBucket: "goldet-504aa.appspot.com",
  messagingSenderId: "36312610816",
  appId: "1:36312610816:web:ded0576d78ebf1ceba00e5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const alertBox = document.getElementById("alertBox");

function showAlert(msg, ok=false){
  alertBox.style.display = "block";
  alertBox.style.background = ok ? "rgba(40,180,40,0.15)" : "rgba(255,0,0,0.15)";
  alertBox.textContent = msg;
  setTimeout(()=> alertBox.style.display = "none", 3500);
}

/* PAGE SWITCHING */
function showSection(id){
  document.querySelectorAll(".section").forEach(s => s.style.display="none");
  document.getElementById(id).style.display="block";
}

/* LOGOUT */
window.logout = function(){
  signOut(auth);
  localStorage.clear();
  window.location.href = "login.html";
};

/* CHECK ADMIN STATUS */
onAuthStateChanged(auth, async user => {
  if (!user) return window.location.href = "login.html";

  const uid = user.uid;
  const snap = await get(ref(db, `users/${uid}`));

  if (!snap.exists() || !snap.val().isAdmin){
    return window.location.href = "login.html";
  }

  loadPending();
  loadUsers();
  loadGameState();
});

/* LOAD PENDING USERS */
async function loadPending(){
  const box = document.getElementById("pendingList");
  const snap = await get(ref(db, "pendingUsers"));

  if (!snap.exists()) {
    box.innerHTML = "<i>No pending users.</i>";
    return;
  }

  box.innerHTML = "";
  snap.forEach(child => {
    const uid = child.key;
    const data = child.val();

    box.innerHTML += `
      <div class="pendingBox">
        <b>${data.username}</b> <br>
        UID: ${uid}<br>
        <button class="smallBtn" onclick="approve('${uid}','${data.username}')">Approve</button>
        <button class="smallBtn" onclick="deny('${uid}')">Deny</button>
      </div>
    `;
  });
}

/* APPROVE USER */
window.approve = async function(uid, username){
  await set(ref(db, `users/${uid}`), {
    username: username,
    approved: true,
    isAdmin: false,
    chatColor: { name:"#fff", text:"#fff" },
    badges: {},
    stats: { packsOpened: 0, messagesSent: 0, golds:{} }
  });

  await remove(ref(db, `pendingUsers/${uid}`));
  showAlert("User approved!", true);
  loadPending();
  loadUsers();
};

/* DENY USER */
window.deny = async function(uid){
  await remove(ref(db, `pendingUsers/${uid}`));
  showAlert("User removed.");
  loadPending();
};

/* LOAD ALL USERS */
async function loadUsers(){
  const box = document.getElementById("usersList");
  const snap = await get(ref(db, "users"));

  if (!snap.exists()) {
    box.innerHTML = "<i>No users yet.</i>";
    return;
  }

  box.innerHTML = "";

  snap.forEach(child => {
    const uid = child.key;
    const d = child.val();

    box.innerHTML += `
      <div class="userBox">
        <b>${d.username}</b> ${d.isAdmin ? "(Admin)" : ""}<br>
        UID: ${uid}<br>
        Packs Opened: ${d.stats?.packsOpened || 0}<br>
        Messages Sent: ${d.stats?.messagesSent || 0}<br>
      </div>
    `;
  });
}

/* GAMESTATE */
async function loadGameState(){
  const snap = await get(ref(db, "gameState"));
  const data = snap.exists() ? snap.val() : {};

  document.getElementById("globalMultiplier").value = data.globalMultiplier || 1;
  document.getElementById("gameStateBox").textContent = JSON.stringify(data, null, 2);
}

window.saveGameState = async function(){
  await update(ref(db, "gameState"), {
    globalMultiplier: Number(document.getElementById("globalMultiplier").value)
  });

  showAlert("Game state updated!", true);
  loadGameState();
};
</script>

</body>
</html>
